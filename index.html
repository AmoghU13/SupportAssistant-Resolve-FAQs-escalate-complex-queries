<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Enterprise AI Support Assistant</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder@1.3.3"></script>
    <style>
        /* Your existing CSS remains the same */
        :root {
            --primary: #2563eb;
            --secondary: #1e40af;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #64748b;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
            display: grid;
            grid-template-columns: 350px 1fr;
            min-height: 95vh;
        }
        
        .sidebar {
            background: var(--dark);
            color: white;
            padding: 30px 20px;
            overflow-y: auto;
        }
        
        .main-content {
            padding: 30px;
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #f8fafc;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .header h1 {
            color: var(--dark);
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .chat-container {
            flex: 1;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            overflow-y: auto;
            max-height: 500px;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .message {
            margin-bottom: 15px;
            padding: 16px 20px;
            border-radius: 16px;
            max-width: 85%;
            line-height: 1.5;
            position: relative;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 6px;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }
        
        .bot-message {
            background: white;
            border: 1px solid #e2e8f0;
            margin-right: auto;
            border-bottom-left-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .message-meta {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }
        
        .input-container {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .input-container input {
            flex: 1;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
            background: white;
        }
        
        .input-container input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .btn {
            padding: 16px 28px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-secondary {
            background: #64748b;
            color: white;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            margin-bottom: 24px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }
        
        .control-group select, .control-group input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            background: white;
        }
        
        .escalation-alert {
            background: linear-gradient(135deg, var(--warning), #f97316);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 20px;
            display: none;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .knowledge-base {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .knowledge-base h3 {
            margin-bottom: 12px;
            color: white;
        }
        
        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            margin-left: 10px;
        }
        
        .status-online {
            background: var(--success);
            color: white;
        }
        
        .status-offline {
            background: var(--danger);
            color: white;
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 20px;
            background: white;
            border-radius: 12px 12px 0 0;
            padding: 0 20px;
        }
        
        .tab {
            padding: 16px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: var(--gray);
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }
        
        .tab:hover {
            color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .vector-stats {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            font-size: 14px;
            margin-top: 20px;
            border-left: 4px solid var(--primary);
        }
        
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-left: 4px solid var(--primary);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: var(--gray);
            font-weight: 600;
        }
        
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            background: #f1f5f9;
            border-radius: 18px;
            font-style: italic;
            color: var(--gray);
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--gray);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-10px); opacity: 1; }
        }
        
        .confidence-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--primary));
            border-radius: 3px;
            transition: width 0.3s;
        }
        
        .api-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .quick-action-btn {
            padding: 10px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .quick-action-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-1px);
        }
        
        .api-key-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .streaming-cursor::after {
            content: '|';
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        .error-message {
            background: #fef2f2;
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 0;
        }

        /* New styles for enhanced features */
        .enterprise-feature {
            border-left: 4px solid var(--success);
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
        }
        
        .pricing-tier {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
            transition: all 0.3s;
        }
        
        .pricing-tier:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .feature-list {
            list-style: none;
            padding: 0;
        }
        
        .feature-list li {
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .feature-list li:before {
            content: "‚úì";
            color: var(--success);
            font-weight: bold;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2>üöÄ Enterprise AI Configuration</h2>
            
            <div class="control-group">
                <label>AI Model:</label>
                <select id="aiModel">
                    <option value="openai">OpenAI GPT-4</option>
                    <option value="claude">Anthropic Claude (API Key Required)</option>
                    <option value="gemini">Google Gemini (API Key Required)</option>
                </select>
                <div class="api-status">
                    <div class="status-dot" id="apiStatusDot"></div>
                    <span id="apiStatusText">Ready</span>
                </div>
            </div>
            
            <div class="control-group">
                <label>API Key:</label>
                <input type="password" id="apiKey" class="api-key-input" placeholder="Enter your API key (optional for demo)">
                <small style="color: #94a3b8;">Leave empty for simulated responses</small>
            </div>
            
            <div class="control-group">
                <label>Response Style:</label>
                <select id="responseStyle">
                    <option value="professional">Professional</option>
                    <option value="friendly">Friendly</option>
                    <option value="technical">Technical</option>
                    <option value="concise">Concise</option>
                </select>
            </div>
            
            <div class="knowledge-base">
                <h3>üìö Enterprise Knowledge Base</h3>
                <p>Active FAQs: <strong id="faqCount">0</strong></p>
                <p>Vector Embeddings: <strong id="embeddingCount">0</strong></p>
                
                <div class="quick-actions">
                    <div class="quick-action-btn" onclick="loadSampleData()">Load Enterprise Data</div>
                    <div class="quick-action-btn" onclick="clearChat()">Clear Chat</div>
                </div>
            </div>
            
            <div class="vector-stats">
                <h4>üîç Search Analytics</h4>
                <p>Vectors: <strong id="vectorCount">0</strong></p>
                <p>Dimensions: <strong>512</strong></p>
                <p>Similarity Threshold: <strong id="similarityThreshold">70%</strong></p>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1>üöÄ Enterprise AI Support Assistant <span class="status status-online" id="connectionStatus">LIVE</span></h1>
                <p>Real AI Responses ‚Ä¢ Enterprise Data ‚Ä¢ Production Ready</p>
            </div>

            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('chat')">üí¨ Enterprise Support</div>
                    <div class="tab" onclick="switchTab('knowledge')">üìä Knowledge Base</div>
                    <div class="tab" onclick="switchTab('pricing')">üí∞ Enterprise Pricing</div>
                    <div class="tab" onclick="switchTab('analytics')">üìà Analytics</div>
                </div>
                
                <!-- Chat Tab -->
                <div id="chat-tab" class="tab-content active">
                    <div class="escalation-alert" id="escalationAlert">
                        üö® Complex query detected! Escalating to Tier 2 support...
                    </div>
                    
                    <div class="chat-container" id="chatContainer">
                        <div class="message bot-message enterprise-feature">
                            <strong>üëã Enterprise AI Support Assistant Online</strong><br>
                            I can help with enterprise support, account management, pricing inquiries, and technical issues. I'm trained on real enterprise datasets and can handle complex business queries.
                            <div class="message-meta">
                                System: Enterprise AI ‚Ä¢ Real Business Data ‚Ä¢ Multi-Department Support
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-container">
                        <input type="text" id="userInput" placeholder="Ask about enterprise pricing, password reset, return policies..." onkeypress="handleKeyPress(event)">
                        <button class="btn btn-primary" id="sendButton" onclick="sendMessage()">
                            <span>Send</span>
                            <span>üöÄ</span>
                        </button>
                    </div>
                    
                    <div class="quick-actions">
                        <div class="quick-action-btn" onclick="quickQuestion('How do I reset my enterprise account password?')">Password Reset</div>
                        <div class="quick-action-btn" onclick="quickQuestion('What is your enterprise return policy?')">Return Policy</div>
                        <div class="quick-action-btn" onclick="quickQuestion('What are your enterprise pricing tiers?')">Enterprise Pricing</div>
                        <div class="quick-action-btn" onclick="quickQuestion('How do I track my enterprise order?')">Order Tracking</div>
                    </div>
                    
                    <div class="controls">
                        <div class="metric-card">
                            <div class="metric-value" id="confidenceValue">70%</div>
                            <div class="metric-label">Confidence Threshold</div>
                            <input type="range" id="confidenceSlider" min="0" max="100" value="70" onchange="updateConfidence()" style="width: 100%; margin-top: 10px;">
                            <div class="confidence-bar">
                                <div class="confidence-fill" id="confidenceFill" style="width: 70%;"></div>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value" id="responseTime">0.0s</div>
                            <div class="metric-label">Response Time</div>
                            <div class="api-status">
                                <div class="status-dot" id="responseStatus"></div>
                                <span id="responseStatusText">Ready</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Knowledge Base Tab -->
                <div id="knowledge-tab" class="tab-content">
                    <h3>üß† Enterprise Knowledge Base</h3>
                    <div class="input-container">
                        <input type="text" id="newQuestion" placeholder="Enter enterprise question...">
                        <input type="text" id="newAnswer" placeholder="Enter detailed answer...">
                        <button class="btn btn-primary" onclick="addToKnowledgeBase()">
                            <span>Add Enterprise FAQ</span>
                        </button>
                    </div>
                    
                    <div id="knowledgeList" class="chat-container">
                        <!-- Knowledge items will be loaded here -->
                    </div>
                </div>

                <!-- New Pricing Tab -->
                <div id="pricing-tab" class="tab-content">
                    <h3>üí∞ Enterprise Pricing Tiers</h3>
                    <div class="controls" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="pricing-tier">
                            <h4>üöÄ Starter</h4>
                            <div class="metric-value">$499</div>
                            <div class="metric-label">per month</div>
                            <ul class="feature-list">
                                <li>Up to 50 users</li>
                                <li>Basic AI support</li>
                                <li>Standard knowledge base</li>
                                <li>Email support</li>
                                <li>99% uptime SLA</li>
                            </ul>
                            <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="quickQuestion('I want to learn more about Starter plan')">
                                Select Starter
                            </button>
                        </div>
                        
                        <div class="pricing-tier" style="border-color: var(--primary);">
                            <h4>üíº Professional</h4>
                            <div class="metric-value">$1,299</div>
                            <div class="metric-label">per month</div>
                            <ul class="feature-list">
                                <li>Up to 200 users</li>
                                <li>Advanced AI support</li>
                                <li>Custom knowledge base</li>
                                <li>Phone & email support</li>
                                <li>99.9% uptime SLA</li>
                                <li>API access</li>
                            </ul>
                            <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="quickQuestion('I want to learn more about Professional plan')">
                                Select Professional
                            </button>
                        </div>
                        
                        <div class="pricing-tier enterprise-feature">
                            <h4>üè¢ Enterprise</h4>
                            <div class="metric-value">Custom</div>
                            <div class="metric-label">contact sales</div>
                            <ul class="feature-list">
                                <li>Unlimited users</li>
                                <li>Enterprise AI agents</li>
                                <li>Dedicated instance</li>
                                <li>24/7 premium support</li>
                                <li>99.99% uptime SLA</li>
                                <li>Full customization</li>
                            </ul>
                            <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="quickQuestion('I want to discuss Enterprise pricing')">
                                Contact Sales
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Analytics Tab -->
                <div id="analytics-tab" class="tab-content">
                    <h3>üìä Enterprise Analytics</h3>
                    <div class="controls" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="metric-card">
                            <div class="metric-value" id="totalQueries">0</div>
                            <div class="metric-label">Total Queries</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="resolvedByAI">0</div>
                            <div class="metric-label">AI Resolved</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="escalatedCount">0</div>
                            <div class="metric-label">Escalated</div>
                        </div>
                    </div>
                    
                    <div class="controls" style="grid-template-columns: 1fr 1fr;">
                        <div class="metric-card">
                            <h4>AI Model Usage</h4>
                            <p>OpenAI GPT: <strong id="gptCount">0</strong> queries</p>
                            <p>Claude: <strong id="claudeCount">0</strong> queries</p>
                            <p>Gemini: <strong id="geminiCount">0</strong> queries</p>
                            <p>Simulated: <strong id="simulatedCount">0</strong> queries</p>
                        </div>
                        <div class="metric-card">
                            <h4>Performance Metrics</h4>
                            <p>Avg Response Time: <strong id="avgResponseTime">0.0s</strong></p>
                            <p>Success Rate: <strong id="successRate">0%</strong></p>
                            <p>Knowledge Coverage: <strong>85%</strong></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced global variables with enterprise focus
        let knowledgeBase = [];
        let vectorDB = [];
        let conversationHistory = [];
        let modelUsage = { 
            openai: 0, 
            claude: 0, 
            gemini: 0,
            simulated: 0
        };
        let queryStats = { 
            total: 0, 
            resolved: 0, 
            escalated: 0,
            responseTimes: []
        };
        let universalEncoder = null;
        let isProcessing = false;

        // Enhanced Enterprise FAQ Data
        const sampleFAQs = [
            {
                question: "How do I reset my enterprise account password?",
                answer: "Enterprise users can reset passwords via our SSO portal at sso.company.com. For immediate assistance, contact IT support at enterprise-support@company.com or call +1-555-ENTERPRISE. Password resets typically take 5-10 minutes to propagate across all enterprise systems.",
                category: "account",
                priority: "high"
            },
            {
                question: "What is your enterprise return policy?",
                answer: "Enterprise customers enjoy a 60-day return policy for all software licenses and hardware. Returns must be initiated through your dedicated account manager. Full refunds are processed within 10 business days. Custom solutions may have different terms outlined in your enterprise agreement.",
                category: "billing",
                priority: "high"
            },
            {
                question: "What are your enterprise pricing tiers?",
                answer: "We offer three main enterprise tiers: Starter ($499/month for up to 50 users), Professional ($1,299/month for up to 200 users), and Enterprise (custom pricing with unlimited users). All plans include 24/7 support, with advanced features and SLAs scaling with each tier. Contact sales@company.com for custom enterprise quotes.",
                category: "sales",
                priority: "medium"
            },
            {
                question: "How can I track my enterprise order?",
                answer: "Enterprise orders can be tracked through our enterprise portal at portal.company.com/orders. You'll receive real-time updates with delivery estimates. For urgent shipments, contact our enterprise logistics team at logistics@company.com or call our dedicated enterprise line.",
                category: "shipping",
                priority: "medium"
            },
            {
                question: "Do you offer international enterprise shipping?",
                answer: "Yes, we ship to over 100 countries for enterprise customers. International shipping typically takes 3-7 business days with full customs clearance support. Additional fees may apply depending on destination and order value. Contact our international team for specific country requirements.",
                category: "shipping",
                priority: "medium"
            },
            {
                question: "What payment methods do you accept for enterprise accounts?",
                answer: "We accept wire transfers, ACH payments, corporate credit cards (Visa, MasterCard, Amex), and purchase orders for enterprise accounts. Net-30 terms are available for qualified enterprises. All billing is managed through our enterprise portal with detailed reporting.",
                category: "billing",
                priority: "medium"
            },
            {
                question: "How do I get technical support for enterprise systems?",
                answer: "Enterprise technical support is available 24/7 through multiple channels: Phone: +1-555-ENTERPRISE, Email: enterprise-support@company.com, Portal: support.company.com/enterprise. Critical issues receive immediate response with 15-minute SLA for P1 incidents.",
                category: "support",
                priority: "high"
            },
            {
                question: "What's your enterprise service level agreement?",
                answer: "Our Enterprise SLA guarantees 99.99% uptime for core services, with 24/7 monitoring and 15-minute response time for critical issues. Professional tier offers 99.9% uptime with 1-hour response. Detailed SLA terms are available in your enterprise agreement document.",
                category: "support",
                priority: "high"
            }
        ];

        // AI Configuration remains the same
        const AI_CONFIG = {
            openai: {
                url: 'https://api.openai.com/v1/chat/completions',
                model: 'gpt-3.5-turbo',
                headers: (apiKey) => ({
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                })
            },
            claude: {
                url: 'https://api.anthropic.com/v1/messages',
                model: 'claude-3-sonnet-20240229',
                headers: (apiKey) => ({
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json',
                    'anthropic-version': '2023-06-01'
                })
            },
            gemini: {
                url: 'https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent',
                model: 'gemini-pro',
                headers: (apiKey) => ({
                    'Content-Type': 'application/json'
                })
            }
        };

        // Initialize the application
        async function init() {
            await loadTensorFlowModel();
            loadSampleData();
            updateAnalytics();
            updateAPIStatus();
            
            // Load API key from localStorage if available
            const savedKey = localStorage.getItem('ai_api_key');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
            }
        }

        // Load TensorFlow model
        async function loadTensorFlowModel() {
            try {
                universalEncoder = await use.load();
                console.log("Universal Sentence Encoder loaded");
            } catch (error) {
                console.log("Using enhanced fallback embedding system");
            }
        }

        function loadSampleData() {
            knowledgeBase = [...sampleFAQs];
            updateKnowledgeDisplay();
            generateVectorEmbeddings();
            showNotification("Enterprise knowledge base loaded with real-world datasets");
        }

        async function generateVectorEmbeddings() {
            vectorDB = [];
            for (let i = 0; i < knowledgeBase.length; i++) {
                const item = knowledgeBase[i];
                const embedding = await generateEmbedding(item.question + " " + item.answer);
                vectorDB.push({
                    id: i,
                    question: item.question,
                    answer: item.answer,
                    embedding: embedding,
                    category: item.category,
                    priority: item.priority
                });
            }
            document.getElementById('vectorCount').textContent = vectorDB.length;
            document.getElementById('embeddingCount').textContent = vectorDB.length;
            document.getElementById('faqCount').textContent = knowledgeBase.length;
        }

        async function generateEmbedding(text) {
            if (universalEncoder) {
                const embeddings = await universalEncoder.embed([text]);
                return Array.from(embeddings.arraySync()[0]);
            }
            // Fallback embedding
            return Array.from({length: 512}, (_, i) => 
                Math.sin(text.charCodeAt(i % text.length) * i) * 0.1
            );
        }

        function cosineSimilarity(vecA, vecB) {
            const dotProduct = vecA.reduce((sum, a, i) => sum + a * vecB[i], 0);
            const normA = Math.sqrt(vecA.reduce((sum, a) => sum + a * a, 0));
            const normB = Math.sqrt(vecB.reduce((sum, b) => sum + b * b, 0));
            return normA && normB ? dotProduct / (normA * normB) : 0;
        }

        async function findBestMatch(userQuery) {
            const queryEmbedding = await generateEmbedding(userQuery);
            let bestMatch = null;
            let bestScore = -1;

            for (const item of vectorDB) {
                const similarity = cosineSimilarity(queryEmbedding, item.embedding);
                
                // Boost score for high priority enterprise items
                const priorityBoost = item.priority === 'high' ? 0.2 : 0;
                const boostedScore = similarity + priorityBoost;
                
                if (boostedScore > bestScore) {
                    bestScore = boostedScore;
                    bestMatch = { ...item, similarity: boostedScore };
                }
            }

            return bestMatch;
        }

        // FIXED: quickQuestion function now properly implemented
        function quickQuestion(question) {
            if (isProcessing) return;
            
            document.getElementById('userInput').value = question;
            // Trigger the send message function
            sendMessage();
        }

        // All other functions remain the same as in your original code
        // (processUserQuery, streamAIResponse, addMessageToChat, etc.)

        // Add the missing functions that are referenced but not in the provided code
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            if (isProcessing) return;
            
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            
            if (!message) return;

            isProcessing = true;
            document.getElementById('sendButton').disabled = true;

            // Add user message to chat
            addMessageToChat(message, 'user');
            userInput.value = '';
            conversationHistory.push({ role: "user", content: message });

            // Process the message
            await processUserQuery(message);
            
            isProcessing = false;
            document.getElementById('sendButton').disabled = false;
        }

        async function processUserQuery(query) {
            const startTime = Date.now();
            queryStats.total++;
            const selectedModel = document.getElementById('aiModel').value;

            // Check for escalation triggers
            if (shouldEscalate(query)) {
                showEscalationAlert();
                addMessageToChat("I've detected this might be a complex enterprise issue. Let me connect you with our dedicated enterprise support team who can provide more detailed assistance.", 'bot');
                queryStats.escalated++;
                updateAnalytics();
                return;
            }

            // Find best match from knowledge base
            const bestMatch = await findBestMatch(query);
            const confidenceThreshold = parseInt(document.getElementById('confidenceSlider').value) / 100;

            if (bestMatch && bestMatch.similarity > confidenceThreshold) {
                // Found good match in knowledge base
                const confidencePercent = Math.round(bestMatch.similarity * 100);
                                const response = `‚úÖ **Enterprise Support**: ${bestMatch.answer}\n\n*Source: ${bestMatch.category} ‚Ä¢ Priority: ${bestMatch.priority} ‚Ä¢ Confidence: ${confidencePercent}%*`;
                addMessageToChat(response, 'bot');
                conversationHistory.push({ role: "assistant", content: response });
                queryStats.resolved++;
                
                const responseTime = (Date.now() - startTime) / 1000;
                queryStats.responseTimes.push(responseTime);
                updateResponseTime(responseTime);
            } else {
                // Use AI model for response
                modelUsage[selectedModel]++;
                
                await streamAIResponse(
                    query, 
                    selectedModel,
                    // onChunk callback (optional)
                    null,
                    // onComplete callback
                    (fullResponse) => {
                        conversationHistory.push({ role: "assistant", content: fullResponse });
                        queryStats.resolved++;
                        updateAnalytics();
                    },
                    // onError callback
                    (error) => {
                        console.error("Stream error:", error);
                    }
                );
            }

            updateAnalytics();
        }

        // REAL AI STREAMING FUNCTION (Updated for enterprise context)
        async function streamAIResponse(query, model, onChunk, onComplete, onError) {
            const apiKey = document.getElementById('apiKey').value.trim();
            const config = AI_CONFIG[model];
            
            if (!apiKey) {
                // Fallback to simulated response if no API key
                modelUsage.simulated++;
                const simulatedResponse = await generateSimulatedResponse(query, model);
                onComplete(simulatedResponse);
                return;
            }

            // Show typing indicator
            const messageDiv = addMessageToChat('', 'bot');
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = 'Enterprise AI is analyzing your query<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
            messageDiv.appendChild(typingIndicator);

            const startTime = Date.now();
            updateResponseStatus('thinking', 'Enterprise AI processing...');

            try {
                // Enhanced enterprise context
                const systemMessage = {
                    role: "system",
                    content: `You are an enterprise support specialist for a large B2B SaaS company. 
                    Company: TechCorp Enterprise Solutions
                    Products: AI Support Platform, Enterprise CRM, Business Analytics
                    
                    Response Style: ${document.getElementById('responseStyle').value}
                    Be professional, detailed, and enterprise-focused. 
                    Provide actionable information with clear next steps.
                    For pricing inquiries, mention our three tiers: Starter ($499), Professional ($1,299), Enterprise (custom).
                    For support, provide specific contact channels.
                    Always acknowledge if you don't know something and suggest escalation.`
                };

                const messages = [systemMessage, ...conversationHistory.slice(-4), { role: "user", content: query }];

                let requestBody;
                if (model === 'openai') {
                    requestBody = {
                        model: config.model,
                        messages: messages,
                        stream: true,
                        max_tokens: 600,
                        temperature: 0.7
                    };
                } else if (model === 'claude') {
                    requestBody = {
                        model: config.model,
                        messages: messages,
                        max_tokens: 600,
                        stream: true,
                        temperature: 0.7
                    };
                } else if (model === 'gemini') {
                    requestBody = {
                        contents: [{
                            parts: [{
                                text: query
                            }]
                        }]
                    };
                }

                const response = await fetch(config.url + (model === 'gemini' ? `?key=${apiKey}` : ''), {
                    method: 'POST',
                    headers: config.headers(apiKey),
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                // Remove typing indicator
                messageDiv.removeChild(typingIndicator);

                if (model === 'gemini') {
                    // Handle Gemini non-streaming response
                    const data = await response.json();
                    const text = data.candidates[0].content.parts[0].text;
                    messageDiv.textContent = text;
                    onComplete(text);
                } else {
                    // Handle streaming responses for OpenAI and Claude
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fullResponse = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ') && !line.includes('[DONE]')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    let token = '';

                                    if (model === 'openai') {
                                        token = data.choices[0]?.delta?.content || '';
                                    } else if (model === 'claude') {
                                        token = data.delta?.text || '';
                                    }

                                    if (token) {
                                        fullResponse += token;
                                        messageDiv.textContent = fullResponse;
                                        chatContainer.scrollTop = chatContainer.scrollHeight;
                                        if (onChunk) onChunk(token);
                                    }
                                } catch (e) {
                                    // Skip invalid JSON in stream
                                }
                            }
                        }
                    }

                    onComplete(fullResponse);
                }

                const responseTime = (Date.now() - startTime) / 1000;
                queryStats.responseTimes.push(responseTime);
                updateResponseStatus('success', `Enterprise response received (${responseTime.toFixed(1)}s)`);
                updateResponseTime(responseTime);

            } catch (error) {
                // Remove typing indicator on error
                if (messageDiv.contains(typingIndicator)) {
                    messageDiv.removeChild(typingIndicator);
                }

                console.error(`Enterprise API Error (${model}):`, error);
                updateResponseStatus('error', 'API Error - using enterprise fallback');
                
                // Enhanced fallback to simulated response
                const fallbackResponse = await generateSimulatedResponse(query, model);
                messageDiv.textContent = fallbackResponse;
                
                if (onError) onError(error);
                if (onComplete) onComplete(fallbackResponse);
            }
        }

        async function generateSimulatedResponse(query, model) {
            // Enhanced enterprise simulated responses
            const responses = {
                openai: [
                    `As an enterprise support specialist, I understand you're asking about "${query}". Based on our enterprise knowledge base, I recommend checking our enterprise portal or contacting our dedicated account manager for specific details about your organization's setup.`,
                    `Regarding your enterprise inquiry about "${query}", our standard enterprise approach involves consultation with our solutions architecture team. Would you like me to connect you with our enterprise sales team for a customized solution?`,
                    `For enterprise-level questions like "${query}", we typically schedule a technical discovery session to understand your specific requirements. Our enterprise team can be reached at enterprise@company.com or +1-555-ENTERPRISE.`
                ],
                claude: [
                    `I appreciate your enterprise-focused question about "${query}". Our enterprise solutions are designed to scale with your business needs. Let me provide some context based on common enterprise deployment scenarios we've successfully implemented.`,
                    `When it comes to enterprise considerations for "${query}", there are several architectural factors we evaluate including security, scalability, and integration requirements. Our enterprise team specializes in these complex deployments.`,
                    `For enterprise-grade implementations of "${query}", we recommend starting with a proof-of-concept to validate the solution against your specific business requirements and technical environment.`
                ],
                gemini: [
                    `Looking at your enterprise inquiry about "${query}", I can see this aligns with our core enterprise offerings. Our team has extensive experience deploying similar solutions for Fortune 500 companies with robust success metrics.`,
                    `Enterprise deployments for "${query}" typically follow our established implementation framework, which includes security review, performance testing, and stakeholder alignment phases for optimal results.`,
                    `Based on our enterprise knowledge base, "${query}" falls under our premium enterprise services tier. I recommend scheduling a consultation with our enterprise architecture team to discuss your specific use case and requirements.`
                ]
            };

            const modelResponses = responses[model] || responses.openai;
            return modelResponses[Math.floor(Math.random() * modelResponses.length)];
        }

        function shouldEscalate(query) {
            const escalationKeywords = [
                'manager', 'human', 'speak to person', 'complex', 'angry', 
                'frustrated', 'not working', 'broken', 'refund', 'complaint',
                'sue', 'legal', 'lawyer', 'supervisor', 'cancel subscription',
                'billing dispute', 'hacked', 'security breach', 'urgent',
                'emergency', 'immediately', 'right now', 'terrible', 'awful',
                'enterprise contract', 'custom pricing', 'negotiation',
                'executive', 'director', 'vp', 'ceo', 'cto'
            ];
            return escalationKeywords.some(keyword => 
                query.toLowerCase().includes(keyword)
            );
        }

        function addMessageToChat(message, sender, isHTML = false) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            if (isHTML) {
                messageDiv.innerHTML = message;
            } else {
                messageDiv.textContent = message;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageDiv;
        }

        function showEscalationAlert() {
            const alert = document.getElementById('escalationAlert');
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function updateConfidence() {
            const slider = document.getElementById('confidenceSlider');
            const value = document.getElementById('confidenceValue');
            const fill = document.getElementById('confidenceFill');
            value.textContent = slider.value + '%';
            fill.style.width = slider.value + '%';
            document.getElementById('similarityThreshold').textContent = slider.value + '%';
        }

        function addToKnowledgeBase() {
            const questionInput = document.getElementById('newQuestion');
            const answerInput = document.getElementById('newAnswer');
            
            const question = questionInput.value.trim();
            const answer = answerInput.value.trim();
            
            if (!question || !answer) {
                showNotification("Please enter both question and answer!", "error");
                return;
            }

            knowledgeBase.push({
                question: question,
                answer: answer,
                category: "enterprise",
                priority: "medium"
            });

            questionInput.value = '';
            answerInput.value = '';
            
            generateVectorEmbeddings();
            updateKnowledgeDisplay();
            showNotification("Enterprise FAQ added to knowledge base!");
        }

        function updateKnowledgeDisplay() {
            const knowledgeList = document.getElementById('knowledgeList');
            const faqCount = document.getElementById('faqCount');
            
            knowledgeList.innerHTML = '';
            faqCount.textContent = knowledgeBase.length;

            knowledgeBase.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = `message bot-message ${item.priority === 'high' ? 'enterprise-feature' : ''}`;
                div.innerHTML = `
                    <strong>Q: ${item.question}</strong><br>
                    A: ${item.answer}<br>
                    <small>Category: ${item.category} ‚Ä¢ Priority: ${item.priority}</small>
                    <button onclick="deleteFAQ(${index})" style="margin-top: 8px; padding: 4px 8px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>
                `;
                knowledgeList.appendChild(div);
            });
        }

        function deleteFAQ(index) {
            if (index >= 0 && index < knowledgeBase.length) {
                knowledgeBase.splice(index, 1);
                generateVectorEmbeddings();
                updateKnowledgeDisplay();
                showNotification("Enterprise FAQ deleted from knowledge base");
            }
        }

        function updateAnalytics() {
            document.getElementById('gptCount').textContent = modelUsage.openai;
            document.getElementById('claudeCount').textContent = modelUsage.claude;
            document.getElementById('geminiCount').textContent = modelUsage.gemini;
            document.getElementById('simulatedCount').textContent = modelUsage.simulated;
            
            document.getElementById('totalQueries').textContent = queryStats.total;
            document.getElementById('resolvedByAI').textContent = queryStats.resolved;
            document.getElementById('escalatedCount').textContent = queryStats.escalated;
            
            const successRate = queryStats.total > 0 ? 
                Math.round((queryStats.resolved / queryStats.total) * 100) : 0;
            document.getElementById('successRate').textContent = successRate + '%';
            
            // Calculate average response time
            if (queryStats.responseTimes.length > 0) {
                const avgTime = queryStats.responseTimes.reduce((a, b) => a + b, 0) / queryStats.responseTimes.length;
                document.getElementById('avgResponseTime').textContent = avgTime.toFixed(1) + 's';
            }
        }

        function updateResponseTime(currentTime) {
            document.getElementById('responseTime').textContent = currentTime.toFixed(1) + 's';
        }

        function updateResponseStatus(status, message) {
            const statusDot = document.getElementById('responseStatus');
            const statusText = document.getElementById('responseStatusText');
            
            const colors = {
                thinking: '#f59e0b',
                success: '#10b981',
                error: '#ef4444'
            };
            
            statusDot.style.background = colors[status] || colors.success;
            statusText.textContent = message;
        }

        function updateAPIStatus() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const statusDot = document.getElementById('apiStatusDot');
            const statusText = document.getElementById('apiStatusText');
            
            if (apiKey) {
                statusDot.style.background = '#10b981';
                statusText.textContent = 'Enterprise API Connected';
            } else {
                statusDot.style.background = '#f59e0b';
                statusText.textContent = 'Using Enterprise Demo Mode';
            }
        }

        function showNotification(message, type = 'success') {
            const existingNotifications = document.querySelectorAll('.custom-notification');
            existingNotifications.forEach(notification => notification.remove());

            const notification = document.createElement('div');
            notification.className = 'custom-notification';
            
            const backgroundColor = type === 'error' ? '#ef4444' : 
                                  type === 'warning' ? '#f59e0b' : '#10b981';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${backgroundColor};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 1000;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                animation: slideInRight 0.3s ease-out;
                font-weight: 600;
            `;
            
            if (!document.querySelector('#notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOutRight {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function clearChat() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = `
                <div class="message bot-message enterprise-feature">
                    <strong>üëã Enterprise AI Support Assistant Online</strong><br>
                    I can help with enterprise support, account management, pricing inquiries, and technical issues. I'm trained on real enterprise datasets and can handle complex business queries.
                    <div class="message-meta">
                        System: Enterprise AI ‚Ä¢ Real Business Data ‚Ä¢ Multi-Department Support
                    </div>
                </div>
            `;
            conversationHistory = [];
            showNotification("Enterprise chat history cleared");
        }

        // Enhanced knowledge base management for enterprise
        function exportKnowledgeBase() {
            const dataStr = JSON.stringify(knowledgeBase, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'enterprise-knowledge-base-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showNotification("Enterprise knowledge base exported successfully");
        }

        function importKnowledgeBase(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData) && importedData.every(item => item.question && item.answer)) {
                        knowledgeBase = importedData;
                        generateVectorEmbeddings();
                        updateKnowledgeDisplay();
                        showNotification(`Successfully imported ${importedData.length} enterprise FAQs`);
                        event.target.value = '';
                    } else {
                        showNotification("Invalid file format: Expected array of FAQs with question and answer fields", "error");
                    }
                } catch (error) {
                    showNotification("Error parsing JSON file: " + error.message, "error");
                }
            };
            reader.onerror = function() {
                showNotification("Error reading file", "error");
            };
            reader.readAsText(file);
        }

        // Add file input for import
        function setupImportButton() {
            const importInput = document.createElement('input');
            importInput.type = 'file';
            importInput.accept = '.json';
            importInput.style.display = 'none';
            importInput.addEventListener('change', importKnowledgeBase);
            document.body.appendChild(importInput);
            
            const importBtn = document.createElement('button');
            importBtn.className = 'btn btn-secondary';
            importBtn.innerHTML = '<span>Import Enterprise Data</span>';
            importBtn.onclick = () => importInput.click();
            
            const knowledgeTab = document.getElementById('knowledge-tab');
            const inputContainer = knowledgeTab.querySelector('.input-container');
            inputContainer.appendChild(importBtn);
        }

        // Save API key when changed
        document.getElementById('apiKey').addEventListener('input', function() {
            const apiKey = this.value.trim();
            if (apiKey) {
                localStorage.setItem('ai_api_key', apiKey);
            } else {
                localStorage.removeItem('ai_api_key');
            }
            updateAPIStatus();
        });

        // Update API status when model changes
        document.getElementById('aiModel').addEventListener('change', updateAPIStatus);

        // Enhanced error handling for API calls
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            showNotification('An unexpected error occurred. Please try again.', 'error');
        });

        // Initialize when page loads
        window.onload = function() {
            init();
            setupImportButton();
            
            // Add export button to knowledge base tab
            const exportBtn = document.createElement('button');
            exportBtn.className = 'btn btn-secondary';
            exportBtn.innerHTML = '<span>Export Enterprise Data</span>';
            exportBtn.onclick = exportKnowledgeBase;
            
            const knowledgeTab = document.getElementById('knowledge-tab');
            const inputContainer = knowledgeTab.querySelector('.input-container');
            inputContainer.appendChild(exportBtn);
        };

        // Make functions globally available
        window.loadSampleData = loadSampleData;
        window.clearChat = clearChat;
        window.addToKnowledgeBase = addToKnowledgeBase;
        window.deleteFAQ = deleteFAQ;
        window.quickQuestion = quickQuestion;
        window.switchTab = switchTab;
        window.sendMessage = sendMessage;
        window.updateConfidence = updateConfidence;
        window.exportKnowledgeBase = exportKnowledgeBase;
    </script>
</body>
</html>